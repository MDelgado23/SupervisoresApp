<app-spinner />

<div
  class="d-flex justify-content-center align-items-start bg-light min-vh-100 py-5 px-3"
>
  <div class="card shadow-lg rounded p-4 w-100" style="max-width: 900px">
    <div class="mb-4 text-center">
      <h4 class="text-primary text-center fw-bold mb-4">Reporte Diario</h4>
    </div>
    <form #reporteForm="ngForm" name="reporteForm">
      <!-- Controlador y Fecha -->
      <div class="d-flex flex-wrap gap-3 mb-4">
        <div class="flex-grow-1">
          <label class="form-label">Controlador</label>
          <input
            type="text"
            class="form-control"
            [value]="usuario?.fullName"
            disabled
          />
        </div>
        <div class="flex-grow-1">
          <label class="form-label">Fecha</label>
          <input
            type="text"
            class="form-control"
            [value]="fechaMostrada"
            disabled
          />
        </div>
      </div>
      <!-- Hora, Móvil, Kilómetros -->
      <div class="d-flex flex-wrap gap-3 mb-4">
        <!-- Hora Inicio + Fin -->
        <div class="flex-grow-1">
          <label class="form-label">Hora Inicio</label>
          <input
            type="time"
            class="form-control mb-2"
            [(ngModel)]="reporte.horaInicio"
            name="horaInicio"
            [disabled]="!editandoIniciales || reporte.finalizado"
            required
          />
          <label class="form-label" *ngIf="reporte.finalizado">Hora Fin</label>
          <input
            type="time"
            class="form-control"
            [(ngModel)]="reporte.horaFin"
            *ngIf="reporte.finalizado"
            name="horaFin"
            [disabled]="!editandoIniciales || reporte.finalizado"
            required
          />
        </div>

        <!-- Móvil -->
        <div class="flex-grow-1">
          <label class="form-label">Móvil</label>
          <select
            class="form-select"
            [(ngModel)]="reporte.vehiculoId"
            name="vehiculoId"
            [disabled]="!editandoIniciales || reporte.finalizado"
            required
          >
            <option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.id">
              {{ vehiculo.patente }}
            </option>
          </select>
        </div>

        <!-- Km Inicio + Fin -->
        <div class="flex-grow-1">
          <label class="form-label">Kilómetros Inicio</label>
          <input
            type="number"
            class="form-control mb-2"
            [(ngModel)]="reporte.kmInicio"
            name="kmInicio"
            [disabled]="!editandoIniciales || reporte.finalizado"
            required
          />
          <label class="form-label" *ngIf="reporte.finalizado">Kilómetros Final</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="reporte.kmFin"
            *ngIf="reporte.finalizado"
            name="kmFin"
            [disabled]="!editandoIniciales || reporte.finalizado"
            required
          />
        </div>
      </div>

      <!-- Observaciones -->
  <div class="mb-3" *ngIf="reporte.finalizado">
    <label class="form-label">Observaciones</label>
    <textarea
      class="form-control"
      rows="3"
      [(ngModel)]="reporte.observaciones"
      name="observaciones"
      [disabled]="!editandoIniciales || reporte.finalizado"
    ></textarea>
  </div>

      <!-- Botones para editar/guardar -->
      <div
        class="d-grid mb-3"
        *ngIf="
          reporteCargado &&
          detalleReportes.length === 0 &&
          !detalleEditando &&
          !editandoIniciales &&
          !reporte.finalizado
        "
      >
        <button
          type="button"
          class="btn btn-warning"
          (click)="editarDatosIniciales()"
        >
          Editar Datos Iniciales
        </button>
      </div>

      <div class="d-grid mb-4" *ngIf="editandoIniciales && !reporte.finalizado">
        <button
          type="button"
          class="btn btn-success"
          (click)="guardarDatosIniciales()"
        >
          Guardar Cambios
        </button>
      </div>

      <!-- Detalles ya cargados -->
      <div
        *ngFor="let detalle of detalleReportes; let i = index"
        class="mb-3 border rounded bg-light"
      >
        <div
          class="p-2 bg-secondary text-white rounded-top d-flex justify-content-between align-items-center"
          style="cursor: pointer"
          (click)="toggleDetalle(i)"
        >
          <strong>Detalle #{{ i + 1 }}</strong>
          <span>{{ getNombreObjetivo(detalle.objetivoId) }}</span>
        </div>

        <div *ngIf="detalle.expandido" class="p-3">
          <!-- Campos del detalle, igual que antes pero dentro de card-body -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Objetivo</label>
              <select
                class="form-select"
                [(ngModel)]="detalle.objetivoId"
                [disabled]="reporte.finalizado"
                name="objetivo-{{ i }}"
              >
                <option
                  *ngFor="let objetivo of objetivos"
                  [value]="objetivo.id"
                >
                  {{ objetivo.name }}
                </option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label>Hora Entrada</label>
              <input
                type="time"
                class="form-control"
                [(ngModel)]="detalle.horaEntrada"
                [disabled]="reporte.finalizado"
                name="horaEntrada-{{ i }}"
              />
            </div>
            <div class="col-md-3 mb-3">
              <label>Hora Salida</label>
              <input
                type="time"
                class="form-control"
                [(ngModel)]="detalle.horaSalida"
                [disabled]="reporte.finalizado"
                name="horaSalida-{{ i }}"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label>Vigilador</label>
              <select
                class="form-select"
                [(ngModel)]="detalle.vigiladorId"
                [disabled]="reporte.finalizado"
                name="vigilador-{{ i }}"
              >
                <option *ngFor="let v of vigiladores" [value]="v.id">
                  {{ v.fullName }}
                </option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label>Actividad</label>
              <select
                class="form-select"
                [(ngModel)]="detalle.actividadId"
                [disabled]="reporte.finalizado"
                name="actividad-{{ i }}"
              >
                <option *ngFor="let act of actividades" [value]="act.id">
                  {{ act.nombre }}
                </option>
              </select>
            </div>
            <div class="mb-3">
              <label>Descripción</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="detalle.descripcion"
                [disabled]="reporte.finalizado"
                name="descripcion-{{ i }}"
              />
            </div>
          </div>

          <!-- Calificaciones -->
          <div class="row">
            <div class="col-6 mb-3" *ngFor="let key of calificacionKeys">
              <label>{{ calificacionLabels[key] }}</label>
              <input
                type="number"
                class="form-control"
                min="1"
                max="5"
                [ngModel]="detalle.calificacion[key]"
                [disabled]="reporte.finalizado"
                (ngModelChange)="detalle.calificacion[key] = $event"
                name="{{ key }}-{{ i }}"
              />
            </div>
          </div>

          <!-- Acciones -->
          <div
            class="d-flex justify-content-end gap-2"
            *ngIf="!reporte.finalizado"
          >
            <button
              type="button"
              class="btn btn-success btn-sm"
              (click)="guardarCambiosDetalle(i)"
            >
              Guardar Cambios
            </button>
            <button
              type="button"
              class="btn btn-danger btn-sm"
              (click)="eliminarDetalle(i)"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>

      <!-- Detalle en edición -->
      <div *ngIf="detalleEditando" class="mb-4 border p-3 rounded bg-light">
        <h6 class="mb-2 fw-bold">Nuevo Detalle</h6>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label>Objetivo</label>
            <select
              class="form-select"
              [(ngModel)]="detalleActual.objetivoId"
              name="objetivo-nuevo"
            >
              <option *ngFor="let objetivo of objetivos" [value]="objetivo.id">
                {{ objetivo.name }}
              </option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label>Hora Entrada</label>
            <input
              type="time"
              class="form-control"
              [(ngModel)]="detalleActual.horaEntrada"
              name="horaEntrada-nuevo"
            />
          </div>
          <div class="col-md-3 mb-3">
            <label>Hora Salida</label>
            <input
              type="time"
              class="form-control"
              [(ngModel)]="detalleActual.horaSalida"
              name="horaSalida-nuevo"
            />
          </div>
          <div class="col-md-6 mb-3">
            <label>Vigilador</label>
            <select
              class="form-select"
              [(ngModel)]="detalleActual.vigiladorId"
              name="vigilador-nuevo"
            >
              <option *ngFor="let v of vigiladores" [value]="v.id">
                {{ v.fullName }}
              </option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>Actividad</label>
            <select
              class="form-select"
              [(ngModel)]="detalleActual.actividadId"
              name="actividad-nuevo"
            >
              <option *ngFor="let act of actividades" [value]="act.id">
                {{ act.nombre }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label>Descripción</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="detalleActual.descripcion"
              name="descripcion-nuevo"
            />
          </div>
        </div>

        <div class="row">
          <div class="col-6 mb-3" *ngFor="let key of calificacionKeys">
            <label>{{ calificacionLabels[key] }}</label>
            <input
              type="number"
              class="form-control"
              min="1"
              max="5"
              [(ngModel)]="detalleActual.calificacion[key]"
              name="{{ key }}-nuevo"
            />
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelarDetalle()"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn btn-success"
            (click)="guardarDetalle()"
          >
            Guardar Detalle
          </button>
        </div>
      </div>

      <!-- Botones finales -->
      <div
        class="d-grid mb-4"
        *ngIf="
          reporteCargado &&
          !detalleEditando &&
          !reporte.finalizado &&
          !mostrarHoraFin
        "
      >
        <button
          type="button"
          class="btn btn-primary"
          (click)="agregarDetalle()"
        >
          Agregar Nuevo Detalle
        </button>
        <button
          class="btn btn-primary mt-3"
          *ngIf="puedeFinalizarReporte() && !mostrarHoraFin"
          (click)="iniciarFinalizacion()"
        >
          Finalizar Supervisión
        </button>
      </div>

      <!-- Hora Fin, Km Fin, Observaciones -->
      <div class="row">
  <div class="col-md-4 mb-3" *ngIf="mostrarHoraFin">
    <label>Hora Fin</label>
    <input
      type="time"
      [(ngModel)]="reporte.horaFin"
      name="horaFin"
      class="form-control"
      required
      (ngModelChange)="onHoraFinChange()"
    />
  </div>

  <div class="col-md-4 mb-3" *ngIf="mostrarKmFin">
    <label>Km Final</label>
    <input
      type="number"
      [(ngModel)]="reporte.kmFin"
      name="kmFin"
      class="form-control"
      required
      (ngModelChange)="onKmFinChange()"
    />
  </div>

  <div class="col-md-4 mb-3" *ngIf="mostrarObservaciones">
    <label>Observaciones</label>
    <textarea
      class="form-control"
      [(ngModel)]="reporte.observaciones"
      name="observaciones"
    ></textarea>
  </div>
</div>


      <div class="d-grid">
        <button
          class="btn btn-success"
          *ngIf="
            puedeFinalizarReporte() && reporteCargado && !reporte.finalizado &&
      mostrarCompletar
          "
          [disabled]="!esReporteValido()"
          (click)="confirmarFinalizarReporte()"
        >
          Completar Reporte
        </button>
      </div>
    </form>
  </div>
</div>
